---
title: "STAA57 Assignment"
author: "Group"
date: "2024-03-28"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning=FALSE,message = FALSE)
```

```{r}
# Read the CSV file located at the specified path into a data frame named 'd'
d =read.csv ("/Users/mark/Desktop/course/staa57/R_CSV_DATA_ANALYZE/g0811_05.csv") 
# Load the 'tidyverse' package, which includes a collection of R packages for data manipulation and visualization
library(tidyverse)
# Load the 'ggplot2' package, a popular R package for creating graphics and plots
library(ggplot2)
# Load the 'knitr' package, which provides tools for dynamic report generation in R
library(knitr)
# Load the 'rpart' package, which provides functions for recursive partitioning and regression trees
library(rpart)

```


# 1.Description
```{r}
# Display the column names of the data frame 'd'
names(d)
```
*[1]"X_id": ID: A unique identifier for each row*

*[2]"Year": The year immigrants immigrated to the Geometry area*

*[3]"Geography": The geographic area of the research, in which Ontario is included in Canada*
     
*[4]"Immig.": The type of immigration.*

*[5]"Reason": Reason for working the part-time job*

*[6]"Age.group": The age group of the immigrants working the part-time job*

*[7]"Both.sexes": The amount of of immigrants of both genders working the part-time job*

*[8]"Men": The amount of male immigrants working the part-time job*

*[9]"Women": The amount of female immigrants working the part-time job*



# 2.The Background of the Data
The reasons for part-time-work by immigration status data from 2006 to 2019 was collected 
by Statistics Canada, specifically by the Labour Force Survey Special 
Tabulations. The data collected includes information on reasons for part-time 
work by immigration status, such as caring for children, going to school, 
and could not find full-time work, looked for full-time work in last month, 
and so on.This data can be reproduced and distributed on an "as is" basis with 
the permission of Statistics Canada (Statistics Canada Open Licence Agreement).
The dataset can be used for analysis and insights into the part-time job 
employment patterns and trends of immigrants looking for part-time jobs in 
Canada from 2006 to2016. 

Additionally，at thebeginning in January 1997, all respondents who usually worked less 
than 30 hours per week at their main or only job (part-time workers) are asked 
if they want to work more or less than 30 hours at a (single) job or business. 
Depending on the response, the main reason for working part-time is collected.
For those who respond that they want to work part-time, the main reason for not 
wanting to work full-time is collected. Responses include: own illness, personal 
or family responsibilities, going to school, personal preference or other. For 
those who respond that they want to work full-time, the main reason for working 
part-time is collected. Responses include: own illness, personal or family 
responsibilities, going to school, business conditions, could not find work 
with 30 or more hours, or other. Those whose response is business conditions or 
could not find work with 30 or more hours are then asked if they looked for work 
with 30 or more hours during the past four weeks. The involuntary part-time rate
is calculated by dividing the number of persons whose response was business 
conditions or could not find work with 30 or more hours by the total number of
persons working part-time at their main or only job.

Overall, the reason-for-part-time-work-by-immigration-status dataset is a 
valuable resource for assessing the effectiveness of employment policies across
immigration status, and informing labor market planning and policy decisions by 
immigration status. 



# 3.What is the over all research question？
As researchers, our overall research question is to investigate the part-time
job employment patterns and trends of immigrants looking for part-time jobs in 
Canada from 2006 to 2019. We aim to analyze various variables, such as age group,
immigration status, gender(sex), reasons, year and geography, to gain insights 
into the connection between immigration status and part-time work, 
and to identify any patterns or trends that may emerge from the data. 
Specifically, our research question is:

1. What is the top 5 reasons why immigrants choose to work part-time?
2. What is the population of immigrants working part-time in 2019？
3. Do more people work part-time as the years go by?
4. Is there an equal ratio of men and women in Canada who choose to work part-time because of child care？



# 4. Tables
## 4.1  The top 5 reasons why Canadians choose to work part-time
```{r}
d_top5=d %>% 
  filter(Reason!="Part-time employment, all reasons" &Immig.=="Total" 
         &Age.group=="15+" &Geography=="Canada") %>% 
          select(Year,Reason,Both.sexes) %>%  group_by(Reason) %>%
          mutate(total_popu_over_years=sum(Both.sexes))
d_top5=d_top5 %>% filter(Year=="2016") %>% 
  select(Reason,total_popu_over_years) %>% arrange(desc(total_popu_over_years))
kable(d_top5[1:5,])

```
This table shows the top 5 most popular reasons for immigrants to work 
part-time in the given dataset. It lists the names of the stations under the 
column “Reason” and the corresponding number of population over years from 2006 
to 2016 under the column “total_popu_over_years”.

The table is sorted in descending order based on the number of reasons of 
finding a part-time, so the reason with the highest numberis listed first. 
According to the table, the most popular starting station is “Going to school” 
with 13826.8 thousands of times, followed by “Personal preference” with 12638.3 
thousands of times, and “Business conditions, did not look for full-time work 
in last month” with 5703.1 thousands of times.

This table can be useful for immigrants or city officials to identify the most 
popular reasons for finding a part-time in immigrant groups and plan their 
careers and life accordingly, such as finding a part-time to accumulate funds 
for academic qualification improvement.

## 4.2 Total population of part-time job over Canada

```{r}
# Create a new data frame 'd_table1' by filtering the data frame 'd' to select 
#rows where:
# - Reason is "Part-time employment, all reasons"
# - Immig. is "Total"
# - Age.group is "15+"
# Then, select only the columns 'Year', 'Geography', 'Both.sexes', 'Men', and 'Women' from the filtered data frame.
# Arrange the resulting data frame by the 'Geography' column.
d_table1=d %>%
  filter(Reason=="Part-time employment, all reasons" &Immig.=="Total" &Age.group=="15+") %>% select(Year,Geography,Both.sexes,Men,Women) %>% arrange(Geography)
kable(d_table1)
```
This table shows the The total number of part-time jobs taken by immigrants of 
each gender in Ontario and Canada as a whole in each yearin the given dataset.
It lists the names of the stations under the column "Year" and "Geography", and 
the corresponding number of population over years from 2006 
to 2016 under the column "Both.sexes.","Men", and "Women".

In the table,there is a noticeable increase in part-time employment figures 
over the years, indicating a rising trend in immigrants seeking part-time work
opportunities during this period.

For Region difference, Ontario consistently exhibits lower part-time employment 
figures compared to the national average, suggesting potential differences 
in part-time employment opportunities or preferences among immigrants across 
different regions.

Overall, while there is an overall upward trend, there are variations in
part-time employment figures from year to year, with fluctuations observed 
across different periods. For example, there is a slight decline in Canada's 
part-time employment figures in 2015, followed by an increase in subsequent 
years, while Ontario generally follows a similar pattern with minor deviations.
This data highlights the importance of policymakers and stakeholders in 
anticipating and addressing the changing needs and preferences of immigrant 
populations. It provides valuable insights for planning targeted support 
services or employment opportunities tailored to part-time workers. 
Consequently, this analysis serves as a foundation for understanding the 
dynamics of immigrant part-time employment in Canada and Ontario, aiding in 
informed decision-making and strategic planning for the future.

## 4.3 The proportion of men and women who choose to work part-time because of "Caring for children" in Canada
```{r}
# Filter the data frame 'd' to select rows where 'Geography' is "Canada"
d_ratio= d %>% filter(Geography=="Canada") 

# Further filter the 'd_ratio' data frame to select rows where:
# - 'Reason' is "Caring for children"
# - 'Age.group' is "15+"
# - 'Immig.' is "Total"
# Then, calculate the ratio of 'Men' to 'Both.sexes' and create a new column 
# named 'Ratio_men'，same step for Ratio_women.
# Finally, select the 'Year' and 'Ratio_men','Ratio_women columns.
d_ratio=d_ratio %>%
  filter(Reason=="  Caring for children" & Age.group=="15+" & Immig.=="Total" ) %>% 
  mutate( Ratio_men=Men/Both.sexes, Ratio_women=Women/Both.sexes) %>% select(Year,Ratio_men, Ratio_women) 

# Display the data in 'd_ratio' as a nicely formatted table using the 'kable' function
kable(d_ratio)
```

This table shows the proportion of men and women working part-time over Canada 
because of "Caring for children" in a given year.
Some trends can be observed from the data:

The proportion of women is generally higher than the proportion of men 
throughout the time frame. This suggests that among men and women, women
are more likely to find a part-time job to care for children. The ratio of 
males to females fluctuated between the years. For example, between 2006 and 
2010, the proportion of men remained relatively stable, while the proportion 
of women increased slightly. However, after 2010, the proportion of men began 
to increase and the proportion of women began to decrease. 
This trend intensified between 2013 and 2019, with the proportion of men rising 
significantly and the proportion of women falling significantly. The proportion 
of men increased from the initial 0.0389990 to 0.0741538 (an increase of 
0.702539). This shows that in this specific field, men's participation is 
gradually increasing and they are increasingly willing to put in more effort 
in childcare. The participation of women gradually decreased, from the initial 
0.9613260 to 0.9258462 (a decrease of 0.0354798).



# 5. Graphs
## 5.1 Graph of population of par-time job men over years in different geography
```{r}
# Create a ggplot object and add a line plot using the 'geom_line' function.
# Map the 'Year' variable to the x-axis, 'Men' variable to the y-axis, and 'Geography' variable to the color aesthetic.
# Use data from the 'd_table1' data frame.
# Label the y-axis as "population of part-time job men in different geography"
# Set the title of the plot as "Graph of population of par-time job men over years"
ggplot()+geom_line(aes(x=Year,y=Men,col=Geography),data=d_table1)+
  ylab("population of part-time job men")+
  ggtitle("Graph of population of par-time job men over years in different geography")
```
**From the above graph:**

This graph indicates population of par-time job men over years in different geography. The x-axis represents years which in the interval of 2006 to 2019, while the y-axis represents the population of part-time job men.

The red line shows the trend of the population of part time job men in Canada and the green line shows the trend of the total number of part time job men in Ontario. They show that although in some specific years the population of part-time job men decreased, the main trend of the population is increasing year by year.

This pattern shows the trend of part time job men is increasing, which may help to reflect some reasons about the current society:
  - The role for men between family and job may be changed. The increasing population may reveal that men became more active in family and children-caring instead of focus on works
  - The workplace or the policy may have changed, which makes men more likely to choose part-time jobs to have more flexible work time and keep the balance between family and work.

# 5.2 Graph of ratio of men working part-time due to children-caring over year
```{r}
# Plot a scatter plot using ggplot, with 'Year' on the x-axis and 'ratio' on the y-axis, based on the data in the 'd_ratio' dataframe.
# Add points to the plot to represent the data points.
# Add a label to the y-axis indicating that it represents the 'ratio'.
# Add a linear regression line to the plot using the geom_smooth function with method="lm" (linear model).
# Add a title to the plot indicating that it represents the graph of the ratio of men working part-time because of children-caring over years.
ggplot(aes(x=Year,y=Ratio_men),data=d_ratio)+geom_point()+
  ylab("ratio of men working part-time due to children-caring")+
  geom_smooth(method="lm")+ 
  ggtitle("Graph of ratio of men working part-time because of children-caring over year") 
```
**From the above graph:**

This graph indicates the ratio of part-time job men whose doing part time due to children-caring is mostly because of children caring. The x-axis represents years which from 2006 to 2019, while the y-axis represents the ratio of part-time job men in each year.

The points indicate the specific ratio in each year and the line shows a increasing trend of the ratio of men doing part-time throughout the year and the ratio of part-time job of men whose doing part time reason almost around in 0.03 to 0.06. In the graph, we can find that most ratio points are around the line, besides some edge values, like 2015's, and the line has a positive slope, which means the ratio of men who do the part-time due to caring for their children is almost increasing over year.

According to the pattern, we can find or guess the trend of ratio increasing may be caused by:
  - The change in family structure, which means more men need to take care of family responsibilities. This may be due to many reasons such as more men choosing to take on childcare responsibilities or the increase in the employment rate of women in the family.
  - The cultural perceptions and values among people may shift, which means men may prefer to strike a balance between career and family life, choosing to work fewer hours to better care for their children.



# 6. Confidence interval and test of hypothesis
According to the 4.3 table ("The proportion of men and women who choose to work part-time because of "Caring for children")
  - H0: The average percentage of men who choose to work part-time because of childcare(μm) is equal to 0.5. i.e.,μm=μw
  - H1: The average percentage of men who choose to work part-time because of childcare(μm) is less than 0.5. i.e.μm<μw
  μw is The average percentage of women who choose to work part-time because of childcare
```{r}

# Perform a one-sample t-test on the 'Ratio_men' variable from the 'd_ratio' data frame.
# Use a confidence level of 95%.
t.test(d_ratio %>% select(Ratio_men),alternative="less",mu=0.5,conf.level=0.95)
```

The One Sample t-test shows a significant difference between the average percentage of men and women who choose to work part-time because of childcare. The p-value (2.2e-16) is less than the significance level of 0.05, indicating strong evidence against the null hypothesis of no difference. The confidence interval (-Inf, 0.05610955) also does not include 0.5, further supporting the conclusion that there is a significant difference between the average percentage.The Confidence interval means, if we keep taking samples(infinite times) and keeping constructing 95% of the cases our CIs(-Inf, 0.05610955) will capture the true average percentage of men who choose to work part-time because of childcare.

Therefore, we can conclude that there is a significant difference in the average percentage of men and women who choose to work part-time because of childcare. More women(percentage is 1-0.05021001=0.9497999) rather than men(percentage is 0.05021001) choose doing part-time job due to caring for children. Thus, with two graph in part 5, the conclusion is that although more and more men were transferring their attention from works to family, the burden of taking care of the family and children still mainly falls on women.



# 7. Calculate p-value of the Hypothesis in part 6 using Bootstrapping
According to the 4.3 table ("The proportion of men and women who choose to work part-time because of "Caring for children")
  - H0: The average percentage of men who choose to work part-time because of childcare(μm) is equal to 0.5. i.e.,μm=μw
  - H1: The average percentage of men who choose to work part-time because of childcare(μm) is less than 0.5. i.e.μm<μw
  μw is The average percentage of women who choose to work part-time because of childcare
```{r}
mu_H0=0.5 # null Hypothesis: mean=0.5
ratio_men=d_ratio %>% select(Ratio_men)
obs_mean=mean(ratio_men[,1]) # mean of Ratio_men

new_x=ratio_men-obs_mean+mu_H0

boot_function2=function(){
  obs.sample=d_ratio %>% select(Ratio_men)
  boot.d = sample_n(new_x,size=nrow(d_ratio), replace=T)
  return(mean(boot.d[,1])) 
}

# Perform bootstrapping by calling 'boot_function2' 1000 times and store the output in 'output'.
set.seed(1)
boot_new_x_bar = replicate(1000, boot_function2())

mean(boot_new_x_bar<obs_mean)

```

**From the above output:**

This part performs a bootstrap hypothesis test to assess whether the average percentage of men who choose to work part-time because of childcare is less than 0.5. 

The output is 0, means the p-value is 0, less than the level of significant 0.05. Therefore, we have strong evidence against the null hypothesis. This implies that the average percentage of men who choose to work part-time because of childcare is significantly less than 0.5, supporting the alternative hypothesis that μm < 0.5. This also validates the conclusion of the part 6 of confidence intervals.

According the output, it revealed that although the trend of ratio of men who choose to work part-time because of childcare is increasing, the amount still small. We can conclude that men’s attention is turning to their families, but the main responsibility for taking care of children and families still lies with women.



# 8 Regression analysis
## 8.1 random forest
```{r}

# Filter the data frame 'd' to exclude rows where 'Reason' is "Part-time employment, all reasons".
d1=d %>% filter(Reason!="Part-time employment, all reasons")
# Assign a binary value to the 'reason' variable based on 'Reason' values:
# - 0 if the reason does not involve looking for full-time work in the last month
# - 1 if the reason involves looking for full-time work in the last month
d1=d1%>% mutate(reason=case_when(Reason=="  Own illness"~0,
                               Reason=="  Caring for children"~0,
                               Reason=="  Other personal or family responsibilities"~0,
                               Reason=="  Going to school"~0,
                               Reason=="  Personal preference"~0,
                               Reason=="  Other voluntary"~0,
                               Reason=="  Business conditions, did not look for full-time work in last month"~0,
                               Reason=="  Could not find full-time work, did not look for full-time work in last month"~0,
                               Reason=="  Business conditions, looked for full-time work in last month"~1,
                               Reason=="  Could not find full-time work, looked for full-time work in last month"~1))
# Load the 'randomForest' package for building random forest models
library(randomForest)
# Build a random forest model ('rforest.m') to predict the 'reason' variable based on other variables.
rforest.m = randomForest(as.factor(reason) ~ Year+Geography+Immig.+Age.group++Both.sexes+Men+Women,data=d1,ntree=500,importance=TRUE)
# Visualize variable importance using the 'varImpPlot' function
varImpPlot(rforest.m)
# Make predictions using the random forest model on the same data ('d1') and calculate the accuracy
d_randomforest=d1%>%mutate(rforest_pred=predict(rforest.m,new_data=d1))
matrix=table(d_randomforest$reason,d_randomforest$rforest_pred)
matrix
mean(sum(diag(matrix))/sum(matrix))
```
**From the above consequence:**

The random forest model built using the provided predictors (Year, Geography, Immig., Age.group, Both.sexes, Men, Women) shows promising performance in predicting the reason variable.The most important predictors for predicting whether the reason involves looking for full-time work in the last month (reason variable) appear to be related to gender (Both.sexes, Men, Women), geography, immigration status (Immig.).

According to the value from the matrix, 6905 observations were correctly predicted as not involving looking for full-time work. And 451 observations were correctly predicted as looking for full-time work. The accuracy is 0.8209821.

# 8.2 Linear regression
```{r}
# Fit a linear regression model ('m2') with 'Both.sexes' as the response variable and 'Year' as the predictor variable using data from 'd_table1'.
m2=lm(Both.sexes~Year,data=d_table1 %>% filter(Geography=="Canada") )
# Display a summary of the linear regression model
summary(m2)
```
**From the above consequence:**

This part fits a linear regression model with 'Both.sexes' as the response variable and 'Year' as the predictor variable using data in the previous table. 


When Year=0, The number of Canadians working part-time is -78715.934, which is meaningless. Slope is 40.769 means that for every one-unit increase in the Year variable, increase the number of part-time Canadians will increase by 40.769 thousand people.
The coefficient of determination (R-squared) of 0.9248 indicates that the model explains 92.48% of the variation in the data. The two p-values are all smaller than the level of significant 0.05, means that we have evidence that year and both.sexes(The total number of people who choose to work part-time) have strong relation.
  
According to the slope of the linear model, we can find the trend of people taking part-time jobs is increasing. Under this condition, we can boldly guess that society’s view of employment may be undergoing a transformation. People are shifting their focus from work to family. This also means that today people may be more interested in building a family than being immersed in a full-time job.



# 9. Cross validation
```{r}
# Create a new dataset `d_cross` by adding a new column `group_ind`, 
# where each observation is randomly assigned to either "train" or "test" group
d_cross=d1 %>% mutate(group_ind = sample(c("train","test"),
                                    size=nrow(d1),
                                    prob = c(0.6,0.4), 
                                    replace = T))
# Fit a random forest model (`randomForest`) to predict the `reason` variable,
# using the specified independent variables, on the observations from the "train" group
rforest.cross = randomForest(as.factor(reason) ~
                           Year+Geography+Immig.+Age.group++Both.sexes+Men+Women,
                         data=d_cross %>% filter(group_ind=="train"),
                         ntree=500, # Number of trees in the random forest
                         importance=TRUE) # Compute variable importance measures
# Predict the values of the `reason` variable using the fitted random forest model
reason.hat=predict(rforest.cross)
# Create a confusion matrix (`matrix_train`) to evaluate the performance of the model
# on the training data by comparing the actual values of `reason` with the predicted values
matrix_train=table(d_cross$reason[d_cross$group_ind=="train"],reason.hat)
# Display the confusion matrix
matrix_train
# Calculate the overall accuracy of the model on the training data
mean(sum(diag(matrix_train))/sum(matrix_train))
```
**From the above output:**

According to the value from the matrix, 4100 observations were correctly predicted as not involving looking for full-time work. And 209 observations were correctly predicted as looking for full-time work. The accuracy is 0.8139403.


for test data
```{r}
# Predict the values of the `reason` variable using the fitted random forest model
# on the observations from the "test" group
reason.hat=predict(rforest.cross,newdata=d_cross %>% filter(group_ind=="test"))
# Create a confusion matrix (`matrix_test`) to evaluate the performance of the model
# on the test data by comparing the actual values of `reason` with the predicted values
matrix_test=table(d_cross$reason[d_cross$group_ind=="test"],reason.hat)
# Display the confusion matrix for the test data
matrix_test
# Calculate the overall accuracy of the model on the test data
mean(sum(diag(matrix_test))/sum(matrix_test))

```
**From the above output:**

In this part, we assesses how well the random forest model performs in predicting the reason variable on unseen test data, providing insight into the model's generalization ability. The output includes the confusion matrix, which gives a breakdown of true positive, true negative, false positive, and false negative predictions, as well as the overall accuracy of the model on the test data.

According to the value from the matrix, 2829 observations were correctly predicted as not involving looking for full-time work. And 139 observations were correctly predicted as looking for full-time work. The accuracy we calculate by this random forest model using cross validation is 0.8096017, which is good model.



# 10. Summary of the reserch
Based on the information presented in the report, the following are the key findings:

1. What is the top 5 reasons why immigrants choose to work part-time?

The 5 top reasons that immigrants choose to work part-time are
"Going to school","Personal preference",
"Business conditions, did not look for full-time work in last month",
"Caring for children", and
"Business conditions, looked for full-time work in last month"

2. What is the population of immigrants working part-time in 2019 over Canada？

The population of immigrants working part-time in 2019 over Canada with 
3610.6 thousands of people.


3. Do more people work part-time as the years go by?

Overall, as years go by,there is an overall upward trend of the total number 
of immigrants working part-time, and there also exist variations in
part-time employment figures from year to year, with fluctuations observed 
across different periods. 

4. Is there an equal ratio of men and women in Canada who choose to work 
part-time because of child care？And what is the percentage of men who choose 
to work part-time because of child care？

Actually not，form our t test，we conclude that there are more 
women(approximately 95%) rather than men(approximately 5%) choose doing 
part-time job due to caring for children. 

Overall, the report provide insights into the details of people 
working part-time-work by immigration status assessing the effectiveness 
of employment policies across immigration status, and informing labor market 
planning and policy decisions by immigration status.